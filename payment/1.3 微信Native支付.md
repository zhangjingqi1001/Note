# 微信支付

# 一、Native支付

## 1.1 时序图

> Native支付流程介绍https://pay.weixin.qq.com/docs/merchant/products/native-payment/development.html

支付的时候需要**四个角色**：微信支付用户、微信客户端、商户后台系统、微信支付系统

当用户点击了“确认支付”，商户后台系统就会生成一笔订单，并且这笔订单信息会在t_order_info表中进行存储

商户后台系统生成完订单之后，会调用微信支付系统的统一下单API，并且微信支付系统此时会生成一笔预支付交易，然后响应给商户后台系统一个预支付交易链接（code_url）。我们会使用一个二维码生成工具将code_url生成一个二维码图片，用户就可以在商户后台系统中看到这个支付二维码图片

用户便可以使用微信客户端的扫一扫功能扫描支付二维码，扫码的过程会直接提交给微信的支付系统，微信支付系统收到用户的扫码请求后会先验证链接的有效性，验证链接有效性后会要求用户进行授权（用户授权的过程就是用户确认支付输入密码的过程）

用户输入密码确认支付，向微信支付平台提交支付授权，微信支付系统再验证授权，完成支付交易

支付交易完成后，会将支付成功或失败的结果通过微信或短信的形式返回给微信客户端，用户就可以看到一个支付交易结果页面

与此同时，我们商户后台系统会接收到微信支付系统的一个异步通知（回调通知），我们商户系统接收到这个通知之后，我们的商户系统需要根据通知里面的响应结果修改我们商户后台系统中的订单状态与订单结果。商户后台系统修改完订单状态后会告诉微信支付系统，我们处理完订单了（我们的回调通知已经成功的接收了）。

但是在异步通知的发送和响应的过程中，有可能会出现网络异常的情况，从而导致发送请求或响应请求失败。也就是说用户收到支付成功的通知，但是商户系统没有收到支付成功的信息。

为了避免上面的情况，我们可以主动调用查询订单的API。

![流程图](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/5_0.png)





## 1.2 Native下单

> 官方地址：[Native下单 - Native支付 | 微信支付商户文档中心 (qq.com)](https://pay.weixin.qq.com/docs/merchant/apis/native-payment/direct-jsons/native-prepay.html)

![image-20231103110225256](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231103110225256.png)

### 1.2.1 Controller

```java
@Slf4j
@CrossOrigin //跨域注解
@RestController
@RequestMapping("/api/wx-pay")
@Api(tags = "微信支付")
public class WxPayController {

    @Autowired
    private WxPayService wxPayService;
    
    @ApiOperation("调用统一下单API，生成支付二维码")
    @PostMapping("native/{productId}")
    public R nativePay(@PathVariable Long productId) {
        log.info("productId - " + productId);

        //Map集合要返回支付二维码连接和订单号
        Map<String, Object> map = wxPayService.nativePay(productId);
        //我们在R类上添加了@Accessors(chain = true)注解，表示可以链式操作
        //链式操作有什么好处/作用？ 可以链式操作 R.ok().setData(map).setCode(); 并且这样后Set方法也会给我们返回一个R对象，更方便
        return R.ok().setData(map);
    }

}
```

### 1.2.2 Service

> [Native开发指引](https://pay.weixin.qq.com/docs/merchant/products/native-payment/development.html)
>
> 文档地址：[Native下单API](https://pay.weixin.qq.com/docs/merchant/apis/native-payment/direct-jsons/native-prepay.html)
>
> 文档中有请求示例和应答示例

我们依然按照 1.1 中的时序图来完成，首先要生成订单

**通过本接口来生成支付链接参数code_url，然后将该参数值生成二维码图片展示给用户。用户在使用微信客户端扫描二维码后，可以直接跳转到微信支付页面完成支付操作**

![image-20231103134053552](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231103134053552.png)































