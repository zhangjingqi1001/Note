# 支付宝支付接入

https://open.alipay.com/



# 一、支付宝接入

打开网站后在下面的地方有需要文档可以查看，然后我们可以看一下”电脑网站支付“

![image-20230905233950847](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230905233950847.png)

> 电脑网站支付：[支付宝开放平台 (alipay.com)](https://open.alipay.com/api/detail?code=I1080300001000041203)
>
> 这个网站里面的介绍挺全的



**常规接入流程**：创建应用、绑定应用、配置秘钥、上线应用、签约功能

**沙箱接入流程**：直接使用沙箱提供的开发参数，无序进行应用的创建、绑定、上线和签约





## 1.1 常规接入流程

### 1.1.1 创建应用

首先在下面这个页面中找到如下标识并点击[支付宝开放平台 (alipay.com)](https://open.alipay.com/)

![image-20230906000256880](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906000256880.png)



之后会有一个接入流程，进行创建

![image-20230906000522412](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906000522412.png)

之后进入开放平台控制台[支付宝开放平台 (alipay.com)](https://open.alipay.com/develop/manage)，并选择一个合适的应用（上一步没创建应用的在这里创建也是可以的）

![image-20230906001036451](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906001036451.png)

之后点击详情，在这个地方有一个AppId，记下来会在配置文件中进行配置

![image-20230906001242048](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906001242048.png)



之后绑定我们的产品能力，之后点击确定

![image-20230906001934954](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906001934954.png)

之后便是这个样子

![image-20230906002135310](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906002135310.png)



设置一下接口加签方式（密钥/证书）

![image-20230906002424204](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906002424204.png)

可以使用密钥，也可以使用证书。我们在这里使用公钥即可

> 只有一些资金支出类接口必须使用证书方式
>
> ![image-20230906002726398](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906002726398.png)

![image-20230906002519584](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906002519584.png)

到了这一步就需要密钥生成器了，生成后复制到下面即可

而且这个参数很重要，记得记下来写到配置文件中

![image-20230906002845609](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906002845609.png)

此时密钥/证书设置完成，下面要设置支付宝网关地址。

支付宝网关地址：开发者调用 OpenAPI 发送 http(s) 请求的目标地址，需配置在AlipayClient中;

这是一个正式的主机地址：https://openapi.alipay.com/gateway.do

![image-20230906003735245](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906003735245.png)

应用网关和授权回调地址在单纯的支付业务中是不需要的

应用网关：用于接收生活号信息的

授权回调：用户信息授权、第三方授权

![image-20230906003909188](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906003909188.png)

再看一下接口内容加密方式，在我们这里是不用的

![image-20230906004108357](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906004108357.png)

![image-20230906004420585](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906004420585.png)

然后点击查看，就会看到一个密钥

![image-20230906004431133](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906004431133.png)





### 1.1.2 绑定应用

支付宝的开放业务存在**三种角色类型**:

* **开发者角色**:需要开发者账号，一股登录支付宝 开放平台 完成应用开发相关操作
* **商家角色**:需要商家账号，一般登录 商家服务平台 开通支付服务并完成商家经营相关操作.
* **系统服务商(ISV)角色**:需要服务商账号，异步登录 服务商平台 完成代商户签约等操作.三种角色的账号都可通过注册实名认证的支付宝账号登录相应平台完成开通



> 由于应用 (APPID)在支付宝开放平台创建，因此归属于对应开发者账号，如果要**在应用中使用支付和资金等相关的能力，必须完成应用(APPD)同商家账号(PID) 的绑定**，通过账号关联可实现将商家签约的业务能力授权给应用(APPID)，应用即可调用需要商家签约的业务能力(如当面付、转账到支付宝账户等)。



我们首先登录一个商家账号

https://b.alipay.com/page/portal/home

差不多就是下面这个样子

![image-20230906204751979](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906204751979.png)

在这里我们要获取一个PID，也就是一个商家账号

![image-20230906204921520](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906204921520.png)

如下所示添加绑定即可

![image-20230906205117357](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906205117357.png)



### 1.1.3 配置秘钥

这一步其实在 1.1.1中做过了

![image-20230906205338278](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906205338278.png)



* **应用公钥public key**：需提供支付宝账号管理者上传到支付宝开放平台

* **应用私钥 private key**：由开发者己保存，需填写到代码中供签名时使用。
* 生成的私钥需妥善保管，避免遗失，不要泄露。

* **秘钥和应用(APPID)**一一对应，即开发者需要为名下的每个应用分别设置密，且不同应用的密钥不能混用.



### 1.1.4 上线应用

在支付宝开放平台https://open.alipay.com/develop/pm/sub/appinfo?appId=2021004115660006

提交审核

![image-20230906210602477](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906210602477.png)

![image-20230906210625831](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906210625831.png)

如果审核成功后，这里显示的是“已上线”,"已上线"状态下的应用能够在生产环境（正式环境）中调用接口

![](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906210957065.png)

### 1.1.5 签约功能

> 有一些功能是必须经过签约才能够使用。签约需要在商家平台进行签约https://b.alipay.com/page/home

应用上线后签约功能、新增功能、删除功能，操作后实时生效。

删除功能时谨慎操作，如果线上已经有用户使用此功能，删除功能后会导致此功能无法使用

**步骤如下所示**

![image-20230906212018935](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906212018935.png)

点击下图中的立即开通

![image-20230906212035809](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906212035809.png)

之后按照要求填写信息

![image-20230906212135803](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906212135803.png)







## 1.2 沙箱接入流程

我们了解了常规接入流程后，发现对普通的学习者是不容易上手的。

但是好人支付宝为我们提供了一个沙箱环境给我们测试使用。真的是个大好人了

https://opendocs.alipay.com/open/02np8i?pathHash=f21715a0

![image-20230906223816693](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906223816693.png)

点击下面这个地方就能进入沙箱平台

![image-20230906224046272](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906224046272.png)

在控制台出就能看到APPID和商家号。

下图的参数都不用我们申请和注册，沙箱都会为我们提供

![image-20230906224240799](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906224240799.png)

各种秘钥在如下地方查看

![image-20230906224616824](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906224616824.png)

我们也可以看一下接口内容加密秘钥，对称秘钥

![image-20230906224955645](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906224955645.png)

沙箱环境中不需要开通产品的使用权限

![image-20230906225142554](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906225142554.png)





# 二、配置准备

## 2.1 properties配置文件

```properties
# 支付宝支付相关参数

# 应用ID,您的APPID，收款账号既是您的APPID对应支付宝账号
alipay.app-id=你的APPID

# 商户PID,卖家支付宝账号ID
alipay.seller-id=你的商户ID

# 支付宝网关
alipay.gateway-url=https://openapi-sandbox.dl.alipaydev.com/gateway.do


# 商户私钥，您的PKCS8格式RSA2私钥
alipay.merchant-private-key= 你的私钥
# 支付宝公钥,查看地址：https://openhome.alipay.com/platform/keyManage.htm 对应APPID下的支付宝公钥
alipay.alipay-public-key= 支付宝公钥
# 接口内容加密秘钥，对称秘钥
alipay.content-key= 生成的秘钥

# 页面跳转同步通知页面路径
alipay.return-url=http://localhost:8080/#/success

# 服务器异步通知页面路径  需http://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问
# 注意：每次重新启动ngrok，都需要根据实际情况修改这个配置
alipay.notify-url=https://a863-180-174-204-169.ngrok.io/api/ali-pay/trade/notify

```

将上面的properties文件变成springboot的标准配置文件（我这里已经添加过了，我再重新写一遍）



![](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906235121302.png)

![image-20230906235313497](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906235313497.png)

然后从这里选择配置文件即可，但是我已经添加过了，所以显示没有

![image-20230906235332428](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906235332428.png)







## 2.2 读取参数

配置类

```java
@Configuration
@PropertySource("classpath:alipay-sandbox.properties")
public class AliPayClientConfig {

}
```

读取参数

```java
@Resource
private Environment config;

@Test
void getAliProperties(){
    log.info(config.getProperty("alipay.app-id"));
}
```



## 2.3 客户端对象

此客户端对象封装了签名和验签功能

https://opendocs.alipay.com/open/01bxlm?pathHash=1cc7d70b

有两个版本，Easy版本实现起来更加的方便简洁，但是Easy版并没有覆盖所有的Alipay的功能

所以我们选择通用版

![image-20230907204202898](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230907204202898.png)

点击下面的“Maven项目依赖”

![image-20230907204515249](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230907204515249.png)

在这里复制依赖粘贴到项目中

![image-20230907204743507](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230907204743507.png)

```xml
<!--ali支付宝的SDK-->
<dependency>
    <groupId>com.alipay.sdk</groupId>
    <artifactId>alipay-sdk-java</artifactId>
    <version>4.38.72.ALL</version>
</dependency>
```

之后我们要创建一个远程连接的终端对象，我们要用这个对象调用ali提供的支付相关的接口

> 我们希望这个对象能够帮我们封装签名和验签
>
> https://opendocs.alipay.com/common/02kf5q

**公钥方式**

公钥方式是指开发者将APPID、应用私钥 (private key)、支付宝公钥(alipay public key) 配在代码中对请求内容进行签名，并对支付宝返回的内容进行验签的方法。

**开放平台SDK封装了签名实现**，只需在**创建 DefaultAlipayClent 对象**时，设置请求网关(gateway)、应用id (app_id)、应用私钥 (private_key)、编码格式 (charset)、支付宝公 (alipay_public .key) 、签名类型(sign_type)即可，**报文请求时会自动进行签名**。

![image-20230907210319321](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230907210319321.png)



```java
AlipayConfig alipayConfig = new AlipayConfig();
//设置网关地址
alipayConfig.setServerUrl(URL);
//设置应用APPID
alipayConfig.setAppId(APPID);
//设置应用私钥
alipayConfig.setPrivateKey(PRIVATE_KEY);
//设置请求格式，固定值json
alipayConfig.setFormat("json");
//设置字符集
alipayConfig.setCharset(CHARSET);
//设置支付宝公钥
alipayConfig.setAlipayPublicKey(ALIPAY_PUBLIC_KEY);
//设置签名类型
alipayConfig.setSignType(SIGN_TYPE);

//构造client
AlipayClient alipayClient = new DefaultAlipayClient(alipayConfig);
```

如下所示：

```java
@Configuration
@PropertySource("classpath:alipay-sandbox.properties")
public class AliPayClientConfig {
    @Resource
    private Environment config;

    @Bean
    public AlipayClient alipayClient() throws AlipayApiException {
        AlipayConfig alipayConfig = new AlipayConfig();
//      设置网关地址
        alipayConfig.setServerUrl(config.getProperty("alipay.gateway-url"));
//      设置应用APPID
        alipayConfig.setAppId(config.getProperty("alipay.app-id"));
//      设置应用私钥
        alipayConfig.setPrivateKey(config.getProperty("alipay.merchant-private-key"));
//      设置请求格式，固定值json
        alipayConfig.setFormat(AlipayConstants.FORMAT_JSON);
//      设置字符集
        alipayConfig.setCharset(AlipayConstants.CHARSET_UTF8);
//      设置支付宝公钥
        alipayConfig.setAlipayPublicKey(config.getProperty("alipay.alipay-public-key"));
//       设置签名类型
        alipayConfig.setSignType(AlipayConstants.SIGN_TYPE_RSA2);
//      构造client
        AlipayClient alipayClient = new DefaultAlipayClient(alipayConfig);
        return alipayClient;
    }
}
```



# 三、API了解

文档地址：https://opendocs.alipay.com/open/028r8t?pathHash=8e24911d&scene=22&ref=api

## 3.1 API预览

**统一收单下单并支付页面接口**：会显示一个支付二维码，用户扫描便可以支付

**统一收单线下交易查询接口**：支付完成后需要查询一下订单的状态，便是此接口。商户可以通过该接口主动查询订单状态，完成下一步的业务逻辑

> 当商户后台、网络、服务器等出现异常，商户系统最终未接收到支付通知； 
>
> 调用支付接口后，返回系统错误或未知交易状态情况； 调用alipay.trade.pay，返回INPROCESS的状态；
>
> 调用alipay.trade.cancel之前，需确认支付状态

**统一收单交易退款接口**：支付成功后需要退款时所要调用的接口

**统一收单交易退款查询**：退款完成时需要查询一下退款的状态

**收单退款冲退完成通知**：完成退款接口调用的时候，一个异步通知的接口

**统一收单交易关闭接口**：关闭订单，比如说超时关单或者管理员主动关单

**查询对账单下载地址**：对账接口，获取账单下载地址，下载账单



**支付成功通知**：如下图所示。支付成功通知或者是支付状态通知，就需要参考下面这个文档

![image-20230907225940460](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230907225940460.png)





## 3.2 签名验签

我们看一下这个支付宝开放平台开发助手

![image-20230907230320178](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230907230320178.png)

点击之后，如下面所示

![image-20230907230429491](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230907230429491.png)

再点击，会有下面的详细介绍

![image-20230907230453423](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230907230453423.png)





## 3.3 支付调用流程

**官网时序图如下图所示**

![image-20230907230806031](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230907230806031.png)

该时序图设计三个方面：用户、商户系统（也就是我们的网站）、支付宝支付平台

1. **用户首先向商户系统发送一个交易请求**，此交易请求相当于下订单了

2. 商户系统调用alipay.trade.page.pay（下单接口），向支付宝平台发起支付请求，**支付宝向用户展示支付二维码和支付宝的登录窗口**

   用户此时有**两种方式选择支付**：

   **一种**是手机支付宝选择扫描支付二维码，进行正常的支付流程，之后用户确认支付即可；

   **另一种**方式是用户选择支付宝的登录界面，输入用户名和支付密码进行登录，登录之后会把页面切换成一个支付页面，用户选择支付渠道并输入支付密码后，确认支付即可。

3. **支付宝再用户确认支付之后会对用户输入的指纹或密码进行确认，进行一个支付校验**

![image-20230917103253480](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230917103253480.png)

4. **如果支付校验成功了，商户系统的浏览器会跳转到支付成功的页面**

支付宝怎么知道要跳转到商户平台的哪个页面呢？

在时序图1.1发起支付请求时，我们会把“商户支付成功页面”以returnUrl的形式转递给支付宝。就是说如果用户支付成功了，你就帮我跳转到returnUrl这个地址

![image-20230917103505964](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230917103505964.png)

> 这个只是用户可以在商户系统中看到“支付成功”的页面，但是商户系统本身也要对订单进行处理

5. **商户系统也要接收到支付成功的通知**

这个”通知“就是我们在商户系统中提前开发的接口，此接口叫”回调接口“。

为什么叫**回调接口**？

因为支付成功后，支付宝那边确认支付成功后，会在支付宝端主动的向我们的商户系统发起调用的一个接口（此接口商户系统开发，支付宝调用）

我们在接口的执行流程当中会修改商户系统中的订单状态，将订单由未支付，改成已支付，这一次支付便完成了

![image-20230917104245635](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230917104245635.png)

6. **有可能由于网络的原因，时序图中的7步骤中商户系统自己编写的接口不能被支付宝成功调用或者说支付宝没有成功调用商户系统中的接口时，商户系统就不能处理订单了，也没有办法把订单的状态由未支付改成已支付，怎么办**？

此时我们的商户系统会向支付宝主动发起一个查看交易状态的请求，我们自己查询一下订单是否支付成功了，如果支付成功了，支付宝就会将订单的交易信息进行返回，商户系统收到后就会修改订单的状态

![image-20230917104959315](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230917104959315.png)

> 这种情况下，我们不开发回调接口，直接查询支付宝的订单状态也是可以的
>
> 两种都使用也是可以的，双重保障



> 此流程图在https://opendocs.alipay.com/open/270/105899?pathHash=d57664bf&ref=api
>
> ![image-20230907230847640](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230907230847640.png)

