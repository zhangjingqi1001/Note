# 支付宝支付

# 一、配置准备

## 1.1 properties配置文件

```properties
# 支付宝支付相关参数

# 应用ID,您的APPID，收款账号既是您的APPID对应支付宝账号
alipay.app-id=你的APPID

# 商户PID,卖家支付宝账号ID
alipay.seller-id=你的商户ID

# 支付宝网关
alipay.gateway-url=https://openapi.alipaydev.com/gateway.do

# 商户私钥，您的PKCS8格式RSA2私钥
alipay.merchant-private-key= 你的私钥
# 支付宝公钥,查看地址：https://openhome.alipay.com/platform/keyManage.htm 对应APPID下的支付宝公钥
alipay.alipay-public-key= 支付宝公钥
# 接口内容加密秘钥，对称秘钥
alipay.content-key= 生成的秘钥

# 页面跳转同步通知页面路径
alipay.return-url=http://localhost:8080/#/success

# 服务器异步通知页面路径  需http://格式的完整路径，不能加?id=123这类自定义参数，必须外网可以正常访问
# 注意：每次重新启动ngrok，都需要根据实际情况修改这个配置
alipay.notify-url=https://a863-180-174-204-169.ngrok.io/api/ali-pay/trade/notify

```

将上面的properties文件变成springboot的标准配置文件（我这里已经添加过了，我再重新写一遍）



![](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906235121302.png)

![image-20230906235313497](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906235313497.png)

然后从这里选择配置文件即可，但是我已经添加过了，所以显示没有

![image-20230906235332428](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230906235332428.png)







## 1.2 读取参数

配置类

```java
@Configuration
@PropertySource("classpath:alipay-sandbox.properties")
public class AliPayClientConfig {

}
```

读取参数

```java
@Resource
private Environment config;

@Test
void getAliProperties(){
    log.info(config.getProperty("alipay.app-id"));
}
```



## 1.3 客户端对象

此客户端对象封装了签名和验签功能

https://opendocs.alipay.com/open/01bxlm?pathHash=1cc7d70b

有两个版本，Easy版本实现起来更加的方便简洁，但是Easy版并没有覆盖所有的Alipay的功能

所以我们选择通用版

![image-20230907204202898](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230907204202898.png)

点击下面的“Maven项目依赖”

![image-20230907204515249](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230907204515249.png)

在这里复制依赖粘贴到项目中

![image-20230907204743507](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230907204743507.png)

```xml
<!--ali支付宝的SDK-->
<dependency>
    <groupId>com.alipay.sdk</groupId>
    <artifactId>alipay-sdk-java</artifactId>
    <version>4.38.72.ALL</version>
</dependency>
```

之后我们要创建一个远程连接的终端对象，我们要用这个对象调用ali提供的支付相关的接口

> 我们希望这个对象能够帮我们封装签名和验签
>
> https://opendocs.alipay.com/common/02kf5q

**公钥方式**

公钥方式是指开发者将APPID、应用私钥 (private key)、支付宝公钥(alipay public key) 配在代码中对请求内容进行签名，并对支付宝返回的内容进行验签的方法。

**开放平台SDK封装了签名实现**，只需在**创建 DefaultAlipayClent 对象**时，设置请求网关(gateway)、应用id (app_id)、应用私钥 (private_key)、编码格式 (charset)、支付宝公 (alipay_public .key) 、签名类型(sign_type)即可，**报文请求时会自动进行签名**。

![image-20230907210319321](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230907210319321.png)



```java
AlipayConfig alipayConfig = new AlipayConfig();
//设置网关地址
alipayConfig.setServerUrl(URL);
//设置应用APPID
alipayConfig.setAppId(APPID);
//设置应用私钥
alipayConfig.setPrivateKey(PRIVATE_KEY);
//设置请求格式，固定值json
alipayConfig.setFormat("json");
//设置字符集
alipayConfig.setCharset(CHARSET);
//设置支付宝公钥
alipayConfig.setAlipayPublicKey(ALIPAY_PUBLIC_KEY);
//设置签名类型
alipayConfig.setSignType(SIGN_TYPE);

//构造client
AlipayClient alipayClient = new DefaultAlipayClient(alipayConfig);
```

如下所示：

```java
@Configuration
@PropertySource("classpath:alipay-sandbox.properties")
public class AliPayClientConfig {
    @Resource
    private Environment config;

    @Bean
    public AlipayClient alipayClient() throws AlipayApiException {
        AlipayConfig alipayConfig = new AlipayConfig();
//      设置网关地址
        alipayConfig.setServerUrl(config.getProperty("alipay.gateway-url"));
//      设置应用APPID
        alipayConfig.setAppId(config.getProperty("alipay.app-id"));
//      设置应用私钥
        alipayConfig.setPrivateKey(config.getProperty("alipay.merchant-private-key"));
//      设置请求格式，固定值json
        alipayConfig.setFormat(AlipayConstants.FORMAT_JSON);
//      设置字符集
        alipayConfig.setCharset(AlipayConstants.CHARSET_UTF8);
//      设置支付宝公钥
        alipayConfig.setAlipayPublicKey(config.getProperty("alipay.alipay-public-key"));
//       设置签名类型
        alipayConfig.setSignType(AlipayConstants.SIGN_TYPE_RSA2);
//      构造client
        AlipayClient alipayClient = new DefaultAlipayClient(alipayConfig);
        return alipayClient;
    }
}
```



# 二、API

文档地址：https://opendocs.alipay.com/open/028r8t?pathHash=8e24911d&scene=22&ref=api

## 2.1 API预览

**统一收单下单并支付页面接口**：会显示一个支付二维码，用户扫描便可以支付

**统一收单线下交易查询接口**：支付完成后需要查询一下订单的状态，便是此接口。商户可以通过该接口主动查询订单状态，完成下一步的业务逻辑

> 当商户后台、网络、服务器等出现异常，商户系统最终未接收到支付通知； 
>
> 调用支付接口后，返回系统错误或未知交易状态情况； 调用alipay.trade.pay，返回INPROCESS的状态；
>
>  调用alipay.trade.cancel之前，需确认支付状态

**统一收单交易退款接口**：支付成功后需要退款时所要调用的接口

**统一收单交易退款查询**：退款完成时需要查询一下退款的状态

**收单退款冲退完成通知**：完成退款接口调用的时候，一个异步通知的接口

**统一收单交易关闭接口**：关闭订单，比如说超时关单或者管理员主动关单

**查询对账单下载地址**：对账接口，获取账单下载地址，下载账单



**支付成功通知**：如下图所示。支付成功通知或者是支付状态通知，就需要参考下面这个文档

![image-20230907225940460](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230907225940460.png)





## 2.2 签名验签

我们看一下这个支付宝开放平台开发助手

![image-20230907230320178](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230907230320178.png)

点击之后，如下面所示

![image-20230907230429491](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230907230429491.png)

再点击，会有下面的详细介绍

![image-20230907230453423](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230907230453423.png)





## 2.3 支付调用流程

![image-20230907230806031](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230907230806031.png)

> 此流程图在https://opendocs.alipay.com/open/270/105899?pathHash=d57664bf&ref=api
>
> ![image-20230907230847640](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230907230847640.png)











