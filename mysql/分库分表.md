# 分库分表

# 一、概述

## 1.1 分库分表原因

**单数据库弊端**

*   IO瓶颈：热点数据太多，数据库缓存不足，产生大量磁盘IO，效率较低。 请求数据太多，带宽不够，网络IO瓶颈。
*   CPU瓶颈：排序、分组、连接查询、聚合统计等SQL会耗费大量的CPU资源，请求数太多，CPU出现瓶颈。

![image-20230531143318439](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531143318439.png)



**为了解决上述问题，我们需要对数据库进行分库分表处理**

​     将数据分散存储，使得单一数据库/表的数据量变小来缓解单一数据库的性能问题，从而达到提升数据库性能的目的。

![image-20230531143353386](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531143353386.png)



## 1.2 拆分策略

​     分库分表的形式，主要是**两种：垂直拆分和水平拆分**。

​     而**拆分的粒度，一般又分为分库和分表**。

​    **分库**： 对一个数据库来进行拆分，将一个数据库中的数据分散地存储在多个数据库当中

​    **分表**：原来存储在一张表结构当中的数据现在要分散地存储在多张表结构中

![image-20230531152127778](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531152127778.png)



### 1.2.1 垂直拆分

**垂直分库**：以表为依据，根据业务将不同表拆分到不同库中。

**特点**

*  每个库的表结构不一样
*  每个库的数据也不一样
*  所有库的并集是全量数据。

![image-20230531154929305](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531154929305.png)



**垂直分表**：以字段为依据，根据字段属性将不同字段拆分到不同表中。

一张表当中存储的数据现在分散的存储在两张表结构当中，而这两张表可以位于不同的服务器当中

**特点**

*  每个表的结构都不一样
*  每个表的数据也不一样，一般通过一列（主键/外键）关联。
*  所有表的并集是全量数据。

![image-20230531155131097](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531155131097.png)



### 1.2.2 水平拆分

**水平分库**：以字段为依据，按照一定策略，**将一个库的数据拆分到多个库中**。

**特点**：

*  每个库的表结构都一样。
*  每个库的数据都不一样。
*  所有库的并集是全量数据。

![image-20230531160656676](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531160656676.png)





**水平分表**：以字段为依据，按照一定策略，**将一个表的数据拆分到多个表中**。



**特点**：

*  每个表的表结构都一样。
*  每个表的数据都不一样。
*  所有表的并集是全量数据。

![](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531160911590.png)

## 1.3 实现技术

​    将数据库进行拆分之后，应用程序需要访问多个数据库。

​    在应用程序当中，我们还需要自行根据当前业务的执行来决定当前要操作哪个数据库，造成应用程序编写代码难度将会增大，而且处理起来相当繁琐。

​    **目前也出现了许多技术来解决分库分表的问题**

*  **shardingJDBC**

    基于AOP原理，在应用程序中对本地执行的SQL进行拦截，解析、改写、路由处理。需要自行编码配置实现，只支持java语言，性能较高。

   

*  **MyCat**

   **数据库分库分表中间件**，不用调整代码即可实现分库分表，支持多种语言，性能不及前者。

   也不用考虑我们每一次需要连接哪个数据库，需要操作哪个数据库（直接访问MyCat），也不用在应用程序当中去集成任何第三方依赖，也不用做其他的编码和配置

![image-20230531162054020](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531162054020.png)



# 二、安装Mycat

## 2.1 介绍



​    Mycat是开源的、活跃的、基于Java语言编写的MySQL数据库中间件。

​    可以像使用mysql一样来使用mycat，对于开发人员来说根本感觉不到mycat的存在。

​    开发人员只需要连接MyCat即可，而具体底层用到几台数据库，每一台数据库服务器里面存储了什么数据，都无需关心。 具体的分库分表的策略，只需要在MyCat中配置即可。

>   **伪装协议**：MyCat伪装了MySQL的协议，所以我们可以将MyCat看做成一台MySQL。
>
>   对于应用程序来说，我们完全不用关心其用的是MyCat还是MySQL，应用程序只需要把MySQL连接换成MyCat连接即可，驱动不用改

![image-20230531162054020](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531162054020.png)

 **优势**

*  性能可靠稳定
*  强大的技术团队
*  体系完善
*  社区活跃



**在MyCat的整体结构中，分为两个部分：上面的逻辑结构、下面的物理结构**

**逻辑库**：逻辑上的数据库，并不存储具体的数据，具体的数据都是在物理结构中存储。

在一个逻辑库当中可以包括若干个逻辑表，一个逻辑表又关联了若干个分片结点，也叫做数据结点。

**分片结点**：也叫数据结点，tableA这个数据分散在3个分片结点当中。tableA中的数据什么时候关联第一个分片结点，什么时候关联第二个分片结点，是由**分片规则**决定的

三个分片结点又关联了三个数据库，底层的物理结构就是真实的数据库，每一个数据库所在的主机，称之为**节点主机**。

>  MyCat是不存数据的，里面只涉及到一些逻辑上的分片以及其他的一些聚合操作，不存储具体的数据，具体的数据依然是在底层MySQL数据库当中进行存储。

![image-20230531191315290](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531191315290.png)





## 2.2 安装

**下载地址**： https://github.com/MyCATApache/Mycat-Server/releases

**解压**

![image-20230531171355528](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531171355528.png)

**配置环境变量**

![image-20230531171347737](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531171347737.png)

**配置PATH**

![image-20230531171502934](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531171502934.png)



**然后直接双击运行bin目录下的startup_nowrap.bat文件，如果运行成功会显示如下**

![image-20230531173035148](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531173035148.png)





# 三、MyCat入门

​     由于tb_order表中数据量很大，磁盘IO及容量都到达了瓶颈，现在需要对tb_order表进行数据分片，分为三个节点，每一个节点主机位于不同的服务器上

>   三个数据库所存放的表结构是一个样子的，但是数据时不同的

![image-20230531192631215](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531192631215.png)





## 3.1 环境准备

四个服务器，MyCat中间件服务器关联三个服务器，并且在上述3台数据库中创建数据库 db01 

>  ​      不要在三台数据库上面创建表，也不用去执行一些增删改的语句，现在所有的操作都针对于MyCat，我们需要配置一些tb_order表的分表策略

![image-20230531193201570](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531193201570.png)





## 3.2 分片配置

### 3.2.1 schema.xml

  在conf/schema.xml文件下我们**需要配置对应的\<schema\>**,也就是需要配置对应的逻辑库，还需要在\<schema\>其当中去配置逻辑表的信息（在这里也就是tb_order）、数据节点、数据结点对应的节点主机



   **分片规则**：这张表中的数据我们应该怎么拆分，由rule分片规则来决定

**\<schema\>**：配置逻辑库

**\<table\>**：配置逻辑表，dataNode属性表示这个逻辑表配置的数据结点有哪几个

**\<dataNode\>**：database属性表示关联的哪个数据库

**\<dataHost\>**：dbDriver属性有两种属性，一个是native，一个是jdbc，在这里我们可以选jdbc，对于MySQL8.0来说，native还不是很完善

**\<writeHost\>**：填写所关联的数据库连接信息

![image-20230531194402899](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531194402899.png)



```xml
<?xml version="1.0"?>
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">
<mycat:schema xmlns:mycat="http://io.mycat/">

	<schema name="DB01" checkSQLschema="true" sqlMaxLimit="100" randomDataNode="dn1">
			<table name="tb_order" dataNode="dn1,dn2,dn3" rule="auto-sharding-long" splitTableNames ="true"/>
	</schema>

	<dataNode name="dn1" dataHost="dhost1" database="db01" />
	<dataNode name="dn2" dataHost="dhost2" database="db01" />
	<dataNode name="dn3" dataHost="dhost3" database="db01" />

	<dataHost name="dhost1" maxCon="1000" minCon="10" balance="0"
			  writeType="0" dbType="mysql" dbDriver="jdbc" switchType="1"  slaveThreshold="100">
		<heartbeat>select user()</heartbeat>

		<writeHost host="hostM1" 
		           url="jdbc:mysql://192.168.200.210:3306??serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8&zeroDateTimeBehavior=convertToNull&useSSL=false&allowPublicKeyRetrieval=true" 
		           user="root"
				   password="1234">
		</writeHost>
	</dataHost>
	
	
	<dataHost name="dhost2" maxCon="1000" minCon="10" balance="0"
			  writeType="0" dbType="mysql" dbDriver="jdbc" switchType="1"  slaveThreshold="100">
		<heartbeat>select user()</heartbeat>

		<writeHost host="hostM1" 
		           url="jdbc:mysql://192.168.200.213:3306??serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8&zeroDateTimeBehavior=convertToNull&useSSL=false&allowPublicKeyRetrieval=true" 
		           user="root"
				   password="1234">
		</writeHost>
	</dataHost>
	
	
	<dataHost name="dhost3" maxCon="1000" minCon="10" balance="0"
			  writeType="0" dbType="mysql" dbDriver="jdbc" switchType="1"  slaveThreshold="100">
		<heartbeat>select user()</heartbeat>

		<writeHost host="hostM1" 
		           url="jdbc:mysql://192.168.200.214:3306??serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8&zeroDateTimeBehavior=convertToNull&useSSL=false&allowPublicKeyRetrieval=true" 
		           user="root"
				   password="1234">
		</writeHost>
	</dataHost>
	

</mycat:schema>
```





### 3.2.2  server.xml

**在此文件下配置哪些用户可以访问MyCat，可以访问MyCat当中的哪些逻辑库、哪些表**

比如下面这个，用户以root 123456登录上来，能够访问的逻辑库就是TESTDB，但是我们访问的逻辑库是db01，所以这个地方要改为db01

```xml
 <!--表示只能读，不能够写 -->
<property name="readOnly">true</property>
```



![image-20230531201229430](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531201229430.png)





需要在server.xml中配置用户名、密码，以及用户的访问权限信息，具体的配置如下：

```sql
	<user name="root" defaultAccount="true">
		<property name="password">123456</property>
		<property name="schemas">DB01</property>
		<property name="defaultSchema">TESTDB</property>
		<!--No MyCAT Database selected 错误前会尝试使用该schema作为schema，不设置则为null,报错 -->
		
		<!-- 表级 DML 权限设置 -->
		<!-- 		
		<privileges check="false">
			<schema name="TESTDB" dml="0110" >
				<table name="tb01" dml="0000"></table>
				<table name="tb02" dml="1111"></table>
			</schema>
		</privileges>		
		 -->
	</user>

	<user name="user">
		<property name="password">123456</property>
		<property name="schemas">DB01</property>
		<property name="readOnly">true</property>
		<property name="defaultSchema">TESTDB</property>
	</user>
```



## 3.3 启动测试

切换到MyCat的安装目录，执行如下指令，启动MyCat：

**占用端口8066**

```
#启动
bin/mycat start
#停止
bin/mycat stop
```

**连接并登录MyCat**

​    是通过MySQL的指令来连接的MyCat，因为MyCat在底层实际上是模拟了MySQL的协议

```sql
mysql -h 192.168.200.210 -P 8066 -uroot -p123456
```



​     我们在schema.xml文件中，配置的是db01逻辑库下有一个tb_order逻辑表。如果我们use table01 ,show tables;看，是有tb_order表的，但是这张表只是在MyCat当中逻辑上存在，但是具体在数据库当中是不存在的

```sql
show tables;
```



**在MyCat当中先将表结构创建出来**

   复制下面的语句，在命令行当中执行

```sql
CREATE TABLE TB_ORDER (
  id BIGINT(20) NOT NULL,
  title VARCHAR(100) NOT NULL ,
  PRIMARY KEY (id)
) ENGINE=INNODB DEFAULT CHARSET=utf8 ;

INSERT INTO TB_ORDER(id,title) VALUES(1,'goods1');
INSERT INTO TB_ORDER(id,title) VALUES(2,'goods2');
INSERT INTO TB_ORDER(id,title) VALUES(3,'goods3');

INSERT INTO TB_ORDER(id,title) VALUES(1,'goods1');
INSERT INTO TB_ORDER(id,title) VALUES(2,'goods2');
INSERT INTO TB_ORDER(id,title) VALUES(3,'goods3');
INSERT INTO TB_ORDER(id,title) VALUES(5000000,'goods5000000');
INSERT INTO TB_ORDER(id,title) VALUES(10000000,'goods10000000');
INSERT INTO TB_ORDER(id,title) VALUES(10000001,'goods10000001');
INSERT INTO TB_ORDER(id,title) VALUES(15000000,'goods15000000');
INSERT INTO TB_ORDER(id,title) VALUES(15000001,'goods15000001');
```



**我们上面插入的数据，是怎么在三个数据库之间进行分布的？**

​    由下图中的属性决定

![image-20230531213149312](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531213149312.png)

​     auto-sharding-long分片规则是一个引用，引用的是MyCat当中给我们提供的分片规则定义的配置文件rule.xml.

​     在这种分片规则当中，是根据id进行分片的

​     在\<algorithm\>标签当中的rang-lang也是一个引用

![image-20230531213440337](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531213440337.png)

rang-lang也是一个引用，引用的是下面的的一个function，

在此function当中，\<property\>标签中有一个属性name，name="mapFile"，mapFile是一个映射文件，此映射文件关联了一个物理文件autopartition-long.txt

![image-20230531213714615](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531213714615.png)

物理文件autopartition-long.txt，此文件中说明了

*  如果id的值在1-500w之间，数据将会存储在第一个分片数据库中。
*  如果id的值在500w-1000w之间，数据将会存储在第二个分片数据库中。
*  如果id的值在1000w-1500w之间，数据将会存储在第三个分片数据库中。
*  如果id的值超出1500w，在插入数据时，将会报错

![image-20230531214058463](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531214058463.png)







# 四、MyCat配置

## 4.1 schema.xml 配置文件

​    **涵盖了MyCat的逻辑库 、 逻辑表 、 分片规则、分片节点及数据源的配置**

**主要涉及到的标签**

*  schema标签
*  datanode标签
*  datahost标签

![image-20230531215440424](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20230531215440424.png)





# 五、MyCat分片









# 六、MyCat管理及监控

