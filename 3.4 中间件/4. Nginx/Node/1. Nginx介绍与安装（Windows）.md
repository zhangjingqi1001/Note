# Nginx介绍与安装（Windows）

# 一、Nginx下载(Windows)

**下载的话点开下面的连接下载就行，我是从官网下载的Nginx**

Nginx是一个反向代理服务器或者说是一个网站服务器

* **Nginx 开源版**

  这就是官网，从这个地方下载的Nginx比较纯粹，**完成了网站服务器、代理服务器、负载均衡器三大功能，但是其他的功能是没有的**，而且在这个版本的Nginx做二次开发的话难度是非常大的

  [Nginx开源版](http://nginx.org/)

  这三大功能无法满足于公司的需求，所以一些公司在原有的Nginx做了加强，其中有Nginx plus、Openresty、Tengine



* **Nginx plus 商业版**

  收费，商业版本全家桶

  [Nginx plus](https://www.nginx.com)



* **Openresty**

  免费而且开源

  将Nginx和Lua脚本进行了整合，以Lua脚本的形式扩展的Nginx

  [Openresty](http://www.openresty.org)



* **Tengine**

  免费而且开源。以C语言和模块化开发的形式丰富和增强的Nginx的原始功能

  [Tengine](http://tengine.taobao.org)

  

# 二、Nginx 介绍



## 2.1 基础命令

**进入安装好的目录 **

![image-20231108142131289](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231108142131289.png)



* **启动服务**

  在安装目录中启动cmd命令行串口输入下面命令

```sh
start nginx
```

我在配置文件中配置的端口是8888，默认是80

![image-20231108143558932](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231108143558932.png)

**或者直接点击Nginx目录下的nginx.exe** 

* **停止服务**

```sh
nginx -s stop
nginx -s quit
```

停止之后再访问localhost:8888地址，就不会访问到页面了

**区别**在于stop是快速停止nginx，可能并不保存相关信息，quit是完整有序的停止nginx

> 假如说Nginx正在下载文件，但是我们执行了quit命令，此时Nginx不会马上退出，而是会等待下载完成文件后再进行退出
>
> 而且执行了quit命令，Nginx不会再接收新的请求了，只会将没完成的请求或任务完成，然后再关闭

* **重新加载配置**

  更改完我们的配置文件后执行下面的命令，可以让新配置的配置直接生效，不用重启Nginx整个服务

```nginx
nginx -s reload
```

当我们执行“nginx -s reload”命令后，它会把原来执行任务的线程优雅的停掉，并且保持之前的连接。

reload之后会重新开启一个线程加载新的配置文件，在原有的线程完成任务之后就会被杀死掉，新的线程由于加载了新的配置，给我们的感觉就像没有重启Nginx服务，但其实是把原有的线程关掉后开启了一个新的，两个线程切换的时候比较优雅而已。



****

****

为了方便我们可以编写一个bat脚本启动

```sh
E:
cd E:\Soft\Nginx_1.22.1\nginx-1.22.1
start nginx
```

## 2.2 目录结构

运行之后会产生许多的temp临时文件

**最主要的文件**

* **conf：存放Nginx的主配置文件**

  主配置文件其实就一个nginx.conf，在这个主配置文件中会引入其他配置文件

  ![image-20231108164040774](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231108164040774.png)

* **html：Nginx默认站点目录**

  > 这两个默认都是可以替换的，可以改成我们想要的页面

  存放一些默认的网页和静态的资源

  ![image-20231108164204488](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231108164204488.png)

  之前我们启动nginx访问出现的下图，就是index.html页面

  假如说访问nginx没有具体指出访问哪个页面，就会访问此目录中的index.html页面、

  也就是说http://localhost:8888/和http://localhost:8888/index.html在这种情况上访问的页面是一样的

  ![image-20231108143558932](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231108143558932.png)

  假如说访问一个不存在的界面，就会出现这个页面

  ![image-20231108172127144](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231108172127144.png)

  http://localhost:8888/50x.html中访问的内容是下面这个样子的

  ![image-20231108172233320](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231108172233320.png)

* **logs： Nginx日志目录**

  access.log文件记录用户的访问日志，记录时间、地点、人物

  > 如果access.log文件写满之后就会无线的报错

  error.log记录访问出错时的日志

  nginx.pid主要是用来记录Nginx主进程的id号的（注意不是线程）

  ![image-20231108172659556](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231108172659556.png)

![image-20231108172335066](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231108172335066.png)



****

> 这个地方借鉴的这篇文章：[【初探篇】Nginx的的目录结构,基本运行原理及基本配置文件_nginx sbin目录_潮浪之巅的博客-CSDN博客](https://hashnode.blog.csdn.net/article/details/124518421)

```sh
├── client_body_temp                 # POST 大文件暂存目录
├── conf                             # Nginx所有配置文件的目录
│   ├── fastcgi.conf                 # fastcgi相关参数的配置文件
│   ├── fastcgi.conf.default         # fastcgi.conf的原始备份文件
│   ├── fastcgi_params               # fastcgi的参数文件
│   ├── fastcgi_params.default       
│   ├── koi-utf
│   ├── koi-win
│   ├── mime.types                   # 媒体类型
│   ├── mime.types.default
│   ├── nginx.conf                   #这是Nginx默认的主配置文件，日常使用和修改的文件
│   ├── nginx.conf.default
│   ├── scgi_params                  # scgi相关参数文件
│   ├── scgi_params.default  
│   ├── uwsgi_params                 # uwsgi相关参数文件
│   ├── uwsgi_params.default
│   └── win-utf
├── fastcgi_temp                     # fastcgi临时数据目录
├── html                             # Nginx默认站点目录
│   ├── 50x.html                     # 错误页面优雅替代显示文件，例如出现502错误时会调用此页面
│   └── index.html                   # 默认的首页文件
├── logs                             # Nginx日志目录
│   ├── access.log                   # 访问日志文件
│   ├── error.log                    # 错误日志文件
│   └── nginx.pid                    # pid文件，Nginx进程启动后，会把所有进程的ID号写到此文件
├── proxy_temp                       # 临时目录
├── sbin                             # Nginx 可执行文件目录
│   └── nginx                        # Nginx 二进制可执行程序
├── scgi_temp                        # 临时目录
└── uwsgi_temp                       # 临时目录

```



## 2.3 基本运行原理

用户通过网络发起一个http://192.168.44.101/index.html请求，Nginx响应请求的步骤如下所示：

1. 会运行nginx可执行文件，linux中在/sbin/nginx，Windows中在安装目录nginx.exe

   > Nginx启动之后会启动许多进程，Nginx是一个多进程进行的模式
   >
   > 在运行的时候分为主进程Master和子进程Worker
   >
   > 主进程Master不会处理业务，它会协调子进程Worker进行工作
   >
   > **当配置文件进行更改后并执行了reload命令**，，Worker进程完成未完成的任务，并且不允许接收新的请求了，当完成了任务后当前Worker进程就会被杀死，新的Worker就会去读取新的配置文件，然后配置文件的校验时有Master进程来完成的。

2. 可执行文件跑起来之后，首先会开启一个Master的主进程，此主进程会把配置文件读取出来，并且会对配置文件做一个校验，如果配置文件中没有错误的话会开启一个子进程，子进程开启之后是真正在服务器运行的进程之一

3. 当主进程和子进程都成功启动后，就会等待用户的请求

4. 用户的请求接入到Nginx是有Work进程响应并解析的

5. Worker已经获取到配置文件中的信息，接收到用户请求后解析请求，会判断自己能不能完成（目录或文件能不能找到）。

   > 比如用户请求http://192.168.44.101/index.html，Nginx接收请求后解析，发现用户想要请求/下的index.html文件，Worker子进程会读取nginx.confg配置文件文件，这个文件中会写站点的主目录在哪，或者说是有几个站点。当前只有一个站点
   >
   > 然后此配置文件中写的是静态的文件存储在html文件夹中，Worker就会从/html/文件下找index.html文件，找到后会进行加载
   >
   > **Worker会读取配置文件并读取用户请求的相应的文件**

   

![image-20231108173723964](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231108173723964.png)







# 三、nginx.conf 配置



## 3.1 初始配置文件

```sh

#user  nobody;       # 指Nginx启动的时候应该以哪个用户启动
worker_processes  1; #

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;

    server {
        listen       80;
        server_name  localhost;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location / {
            root   html;
            index  index.html index.htm;
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        # proxy the PHP scripts to Apache listening on 127.0.0.1:80
        #
        #location ~ \.php$ {
        #    proxy_pass   http://127.0.0.1;
        #}

        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
        #
        #location ~ \.php$ {
        #    root           html;
        #    fastcgi_pass   127.0.0.1:9000;
        #    fastcgi_index  index.php;
        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
        #    include        fastcgi_params;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #    deny  all;
        #}
    }


    # another virtual host using mix of IP-, name-, and port-based configuration
    #
    #server {
    #    listen       8000;
    #    listen       somename:8080;
    #    server_name  somename  alias  another.alias;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}


    # HTTPS server
    #
    #server {
    #    listen       443 ssl;
    #    server_name  localhost;

    #    ssl_certificate      cert.pem;
    #    ssl_certificate_key  cert.key;

    #    ssl_session_cache    shared:SSL:1m;
    #    ssl_session_timeout  5m;

    #    ssl_ciphers  HIGH:!aNULL:!MD5;
    #    ssl_prefer_server_ciphers  on;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}

}

```



## 3.2 配置解释

> [【初探篇】Nginx的的目录结构,基本运行原理及基本配置文件_nginx sbin目录_潮浪之巅的博客-CSDN博客](https://hashnode.blog.csdn.net/article/details/124518421)

**将注释删除后查看多少核心配置，先看一些简单后，后面会再有解释**

```sh
# 指Nginx启动的时候应该以哪个用户启动
#user  nobody;    

#工作的进程个数。
#这个地方的个数会对应当前服务器的物理CPU内核数。假如物理虚拟机内核数是1，给worker_processes的值是10，这样是没有多大的意义的。
#如果把一个CPU绑定到多个进程上同时去执行任务，它会分开时间段执行好多任务，这样的话效率其实是降低的
worker_processes  1; 

# 事件驱动模块
events {
    # 每一个Worker进程可以创建多少个；连接
    #单个进程最大连接数。 最大连接数=连接数*进程数
    #根据硬件调整，和前面工作进程配合起来用，尽量大，但是别把cpu跑到100%就行
    worker_connections  1024;
}


#
http {
    #把另外的一个配置文件引到当前的配置文件当中
    #mime.types文件记录的是 请求的头，在这个头里面会标明当前返回或发送的文件是一个什么类型的
    include       mime.types;
    
    #默认文件类型。假如预先定义的类型mime.types没匹配上，那就application/octet-stream格式的流的方式传输给我们的客户端（客户端一般就是指浏览器）
    default_type  application/octet-stream;

    #数据零拷贝。不需要复制和拷贝了，就是直接从A的电脑里通过无限到了B的电脑了，减少了A电脑拷贝到U盘，再从U盘拷贝到B的电脑的过程（减少了中间的调度，同时也减少了复制的过程）
    sendfile        on;

    #长连接超时时间，单位是秒
    keepalive_timeout  65;

#一个主机或者多个主机都可以配置在nginx.conf配置文件里，也就是一个nginx可以运行多个主机，每个主机都会有独立的站点，互相不干扰
#一个server代表一个主机
    #虚拟主机 vhost
    server {
         #当前主机监听端口
        listen       80;
        
        #当前主机的主机名，但是主机名必须是可以解析的，比如localhost，在host文件中对应的127.0.0.1
        #这个地方可以配置主机名，也可以配置域名
        server_name  localhost;
        
        #配置根目录以及默认页面
        #独立站点，独立根目录。
        #域名后面跟的子目录或者路径（就是URI）。
        #比如URL： http://zhangjingqi.com/xsxs/index.html,其中URI指的是/xsxs/index.html，location就是来匹配URI的
        location / {
            #当匹配上URI之后从哪个目录找页面
            #html是一个相对路径，相对的是nginx主目录
            root   html;
            
            #如果没有默认页的话，就展示下面两个页面
            index  index.html index.htm;
        }
        
        #出错页面配置
        #一旦出错就会访问/50x.html这个地址。
        #假如说站点是http://zhangjingqi.com/xsxs/index.html，出错后访问的就是http://zhangjingqi.com/50x.html
        error_page   500 502 503 504  /50x.html;
        
        # 从html文件夹中招50x.html文件
        location = /50x.html {
            root   html;
        }
    }

}
```





**可以看一下配置文件mime.types的内容**

这里面不可能包含所有的文件类型，想要的话可以自己加

![image-20231109134903427](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20231109134903427.png)























