# MQ基础

[TOC]



# 一、通讯介绍

## 1.1 基础介绍

通讯分为**同步通讯和异步通讯**

![img](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/88189d746007ce18ce93ea8319cb9b59.png)

> 同步通讯就类似我们的打电话、发视频，假如我们和用户A通话的时候，用户B和用户C就打不进来
>
> 异步通讯类似我们平时发送的微信，不论我们给多少人发信息，或者多少人给自己发信息，我们都能发送或者收到，所以说异步通讯的并发能力很强

大多数情况下会使用同步，对并发没有很高的要求，但是对时效性有很高的要求，因为我希望我查询到的信息立马就在下面的业务中用到，那必须得用同步调用

> 因为异步调用只是通知干一件事情，干完之后又不会告诉我，我们没有办法等待异步通讯的结果

**而如果说不需要对方的结果，只是希望对方能干一件事情，对吞吐量的要求、并发的要求较高，还希望解除服务间的耦合关系，那此时应该使用异步通信**



之前我们的调用使用的是open Feign，这其实就是一个同步的调用，发起一个请求后，要实时的等待返回的结果，在等待的过程中其实就是阻塞的

比如下面的登录服务，登录上后，我们会调用另外一个微服务进行账号的封控分析，假如说此账号的登录存在风险的话，我们会调用另外一个微服务向用户发送短信。如果风控分析和短信服务都是同步的话，会导致用户登录等待的时间过长，登录的性能也不是很好。

![image-20240506142135297](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240506142135297.png)

**为了提高性能，我们就不使用上面的同步通讯了，而是准备一个MQ做异步通讯**。

登录成功之后，我们不着急去做后面的事情，而是发送一条消息到MQ就行，此时登录的业务就完成，并发能力也会大大提高。

风控服务和短信服务都可以去监听MQ的消息，当收到MQ的消息的时候，就可以去做对应的事情，完成并行执行，这样效率会大大提高。

![image-20240506143542385](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240506143542385.png)



## 1.2 同步调用

我们在支付的时候，第一件事其实就是扣用户的余额，因为只有余额充足了，才会做后续的事情。

之后会修改支付的状态，再修改支付订单的状态。

![image-20240506144818972](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240506144818972.png)

支付服务最重要的一件事情就是扣除余额、更新支付状态，而更新订单状态这种其实就是额外的一些操作了。

* **拓展性差，耦合度高**

上面的做法存在业务耦合的问题，假如现在我们有了发送短信的新需求，我们需要改动支付服务的代码增加发送短信功能，如下所示

![image-20240506150200202](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240506150200202.png)

如果不断增加新需求的话，我们就需要在支付服务上不停的增加代码。

我们支付服务最基础的代码虽然是写完了，但是随着产品经理提出的新需求，我们会不断的在支付服务上调用不同的服务。



* **性能下降及浪费资源**

**调用者需要等待服务提供者响应，如果调用链过长则响应时间等于每次调用的时间之和**。

我们调用支付服务的时候，因为是同步调用，所以线程的释放会在用户服务、更新支付状态、交易服务、通知服务等完成之后。在等待的时候CPU也会卡着、线程也会占用着。

假如一个服务是50ms，那完成支付服务的时间就是50ms*服务个数，时间是挺长的。

**调用链中的每个服务在等待响应过程中，不能释放请求占用的资源，高并发场景下会极度浪费系统资源**



* **级联失败**

进行业务的时候，假如交易服务发生了异常，整个支付服务相当于全部失败了，并且这个故障我们迟迟没有解决，很有可能会拖累整个支付服务，导致级联失败

**如果服务提供者出现问题，所有调用方都会跟着出问题，迅速导致整个微服务集群故障**



* **实效性强**

时效性较强，可以立即得到结果



## 1.3 异步调用

异步调用常见实现就是事件驱动模式

异步调用方式其实就是基于消息通知的方式，一般包含三个角色：

* **消息的发送者**

  投递消息的人，就是原来的调用方。我们不再直接调用消费者，而是改成了向消息的代理发送一条消息

  

* **消息的代理**

  负责管理、暂存、转发消息，转发给消息的消费者

  

* **消息的消费者**

  接收和处理消息的人，就是原来的服务提供方

![image-20240506153258904](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240506153258904.png)

支付服务不再同步调用业务关联度低的服务，而是发送消息通知到Broker。

![image-20240506154023208](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240506154023208.png)

**优势**

* **解除耦合，拓展性强**

* **无需等待，性能好**

* **服务没有强依赖，不担心级联失败问题，隔离性好**

* **可以缓存消息，进行流量削峰填谷**

  Broker就像一个大坝，压力都由Broker扛着

比如现在很多用户都在进行支付服务，有着更多的请求。假设订单服务、仓储服务、短信服务都只能一次处理一个请求，来个多个请求之后一次性处理不了，此时Borker就起到了一个缓冲的作用，将多余的请求拦截下来，并根据服务一次能处理几个请求分发给服务，这样以来服务处理请求的速度一直按照自己的能力来

**劣势**

* **不能立即得到调用结果，时效性差**
* **不确定下游业务执行是否成功**
* **业务安全依赖于Broker的可靠性**



## 1.4 MQ技术选型

MQ（Message Queue）消息队列，字面看是存放消息的队列，也就是异步调用中的Broker

因为是队列，所以先发的消息先出，消息队列默认是有序的

![image-20240506155549266](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240506155549266.png)

支持的协议越多，以后能干的事情就越多

RabbitMQ、RocketMQ、Kafka都是能够支持分布式集群





# 二、基本入门



## 2.1 安装（Windows）

官方网站：https://www.rabbitmq.com/

> 安装笔记借鉴：[windows环境下安装RabbitMQ（超详细）_windows安装rabbitmq-CSDN博客](https://blog.csdn.net/qq_25919879/article/details/113055350?ops_request_misc=%7B%22request%5Fid%22%3A%22167875575016800192257608%22%2C%22scm%22%3A%2220140713.130102334..%22%7D&request_id=167875575016800192257608&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-113055350-null-null.142^v73^insert_down1,201^v4^add_ask,239^v2^insert_chatgpt&utm_term=rabbitmq安装&spm=1018.2226.3001.4187)



我出现的问题是运行RabbitMQ之后无法查看web页面

解决方案：

```sh
rabbitmq-plugins enable rabbitmq_management
```

执行完这行代码后，需要进入sbin目录下开启rabbitmq-server.bat，此时进入浏览器才能显示rabbit MQ界面

如果直接查看status会报错，显示rabbitMQ没有运行

一定要确定RabbitMQ服务是启动的



## 2.2 界面

点击下面的页面进入到下面的RabbitMQ，进入之前需要先登录，**默认的登陆账号和密码都是guest**

[RabbitMQ Management](http://localhost:15672/)

- **Overview是总览，主要记录结点的详细信息**

  包括节点、端口、消息发送的统计

  如果是集群的话，下面就会有很多的集群信息

![image-20240506161900240](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240506161900240.png)



- **Connections连接**

  将来消息的发送者和接收者都需要跟MQ建立连接，一旦建立连接，在这个地方就会展示出来

![img](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/e535ff4686db380f505c445053436d85.png)



- **Channels通道**

将来建立连接之后一定要建立一个通道，不论是生产者还是消费者，基于Channels完成消息的发送和接收

> 在发送消息前需要建立一个频道，在这个频道里面发送消息

![img](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/ef39f5bccba56e09aeb24bcf0a5b9edc.png)



- **Exchanges 交换机（路由器）**

![img](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/9f05eb97e2d4c1376cc835f7e840f292.png)



- **Queues 队列**

队列就是来做消息存储的，目前还没有任何消息

![img](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/5fe23046696c82607550bac8a7ed3e77.png)

- **Admin 管理**

![img](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/6d4460badf1fdedf279104d45cd680a7.png)

我们还可以新添加一个用户

![img](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/5e6f70e75dd3142741e04a214586a64b.png)

将来我们创建用户之后会有一个虚拟主机Virtual Host，各个虚拟主机之间是相互隔离的，互相看不到的，不会互相干扰

> 互相隔离其实挺好的，因为大多数公司很多项目会公用同一个MQ集群，我们就可以给每一个项目创建一个账号，也就是说不同的Virtual Host会有自己不同的交换机和队列
>
> 我们连接的时候，找到其中一个Virtual Host连接即可



## 2.3 结构

![img](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/11cd983b59778c2644a97df4cc6d2a93.png)

Publisher(消息发送者)会把消息发送到exchange（交换机），交换机负责路由把消息投递到队列，队列负责暂存消息，Consumer（消费者）再从队列中获取消息并处理消息



## 2.4 快速入门

**在RabbitMQ的控制台完成下列操作**：

* 新建队列hello.queue1和hello.queue2
* 向默认的amp.fanout交换机发送一条消息
* 查看消息是否到达hello.queue1和hello.queue2
* 总结规律



1. **新建队列**

![image-20240506171240485](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240506171240485.png)

![image-20240506171308026](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240506171308026.png)





2. **向默认的amp.fanout交换机发送一条消息，看消息是否能到达队列**

> 如果交换机和队列没有绑定，直接向交换机发送消息是不行的

使用下图所示的交换机，可以点击进去看详情信息

![image-20240507105700428](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240507105700428.png)

假如说没填写Routing key的时候，是不会路由到对应的队列的

因为交换机和队列之间需要存在路由关系，这样交换机才能将消息转发到对应的队列上

交换机是负责路由和转发消息的，本身没有存储消息的能力

1. **绑定 Bindings** 

添加一个绑定到当前的交换机

![image-20240507110515331](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240507110515331.png)



2. **发送消息 Publish message**![image-20240507110550334](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240507110550334.png)



3. **查看队列是否收到**

![image-20240507110622968](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240507110622968.png)

我们点击去队列，还可以偷偷的看到队列中的消息，不能修改

![image-20240507110745531](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240507110745531.png)



## 2.5 数据隔离

在RabbitMQ中是有虚拟主机Virtual Host，各个虚拟主机之间是相互隔离的，互相看不到的，不会互相干扰

交换机和队列都有自己所属的虚拟主机，如下图所示

![image-20240507111348544](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240507111348544.png)

![image-20240507111251138](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240507111251138.png)



**查看虚拟主机**

在Admin页面，我们可以看到只有一个虚拟主机，属于guest用户

![image-20240507111504198](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240507111504198.png)



**需求**

* **新建一个用户testall**

  ![image-20240507111931088](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240507111931088.png)

  效果如下所示，“No access”表示没有可访问的虚拟主机，也就是说用testall账号登录的时候，虽然能够看到队列或其他信息，但是是没有办法进行操作的

  ![image-20240507112009353](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240507112009353.png)

  比如获取一下消息，发现是被拒绝的，但是不能操作为什么能看到呢？

  因为我们testall账号在创建的时候，权限是超级管理员

  ![image-20240507112339309](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240507112339309.png)

  所以我们需要给testall账号创建一个虚拟主机，和账号guest隔离开了

* **为testall用户创建一个Virtual Host**

![image-20240507140850278](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240507140850278.png)

之后选择本账号中自己的虚拟主机

![image-20240507140932632](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240507140932632.png)

目前的交换机如下图所示

![image-20240507141133831](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240507141133831.png)

* **测试不同virtual host之间的数据隔离现象**

  





















